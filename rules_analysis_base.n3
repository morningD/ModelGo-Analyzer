@prefix math: <http://www.w3.org/2000/10/swap/math#> .
@prefix list: <http://www.w3.org/2000/10/swap/list#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix string: <http://www.w3.org/2000/10/swap/string#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix mg: <http://www.modelgo.li/rdf/terms#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix : <http://example.org/ns#>.


# Each work intended for publication has a unique PublishTask associated with each Publish action
:PublishTask a rdfs:Class ;
    rdfs:comment "This class represents the publishing information and associated triggered restrictions of a work." .

:hasPublishTask a rdfs:Property ;
    rdfs:domain mg:Work ;
    rdfs:range :PublishTask .

####    Create PublishTask  ####
{ # Create PublishTask from the final work
    ?action a mg:Publish .
    ?action!mg:hasOutput mg:targetWork ?work .
    ?work mg:hasPublishPolicy ?policy .
    (?action ?work "PublishTask") log:skolem ?geniri .
} => {
    ?geniri a :PublishTask ;
        mg:targetAction ?action ;
        mg:targetWork ?work ;
        mg:hasPublishPolicy ?policy .
    ?work :hasPublishTask ?geniri .
} .
{ # Proliferate Publish Task to mixwork and subwork
    ?pt a :PublishTask .
    ?work :hasPublishTask ?pt .
    ?has list:in (mg:hasMixwork mg:hasSubwork) .
    ?work ?has ?mwsw .
    ?pt mg:targetAction ?action .
    ?pt mg:targetWork ?pubw .
    (?action ?pubw "PublishTask") log:skolem ?geniri .
} => {
    ?mwsw :hasPublishTask ?geniri .
} .

####    Create Ruling for Publishing Subwork  ####
# Note: Since the rulings of a subwork have no effect on license determination, we create the rulings in this analysis procedure
{ # The ruling for publishing subwork self
    ?subw a mg:Work .
    ?subw :hasPublishTask ?pt .
    ?work mg:hasSubwork ?subw . 
    ?pt mg:targetAction ?action .
    ?subw mg:hasLicense ?linfo .
    ?linfo mg:hasRule ?rule .
    ?subw mg:hasWorkForm ?subwf .
    ?rule mg:targetActionType mg:Publish . # Rule for Publish
    ?rule mg:targetInputWorkForm ?subwf . # Matching input work form
    ?rule mg:targetOutputWorkForm ?subwf . # Subwork intended be published under original work form
    ?rule mg:hasOutputDef ?outputDef . # Find the matching output definition (no use)
    (?action ?subw ?work "ruling") log:skolem ?geniri . # Ensure that only one ruling is created for each (Publish, subwork, publication) tuple
} => {
    ?geniri a mg:Ruling ;
        mg:targetWork ?subw ;
        mg:targetAction ?action ;
        mg:hasLicense ?linfo ;
        mg:hasRule ?rule . # Rule is binded
        #mg:hasOutputDef ?outputDef . # OutputDef is out of context
    ?work mg:hasRuling ?geniri . # Add the ruling that publishing subwork to its following work
} .
{ # The ruling for publishing mixwork contained in the subwork
    ?subw a mg:Work .
    ?subw :hasPublishTask ?pt .
    ?work mg:hasSubwork ?subw .
    ?subw mg:hasMixwork ?submixw .
    ?pt mg:targetAction ?action .
    ?submixw mg:hasLicense ?linfo .
    ?linfo mg:hasRule ?rule .
    ?subw mg:hasWorkForm ?subwf .
    ?submixw mg:hasWorkForm ?submixwf .
    ?rule mg:targetActionType mg:Publish . # Rule for Publish
    ?rule mg:targetInputWorkForm ?submixwf . # Matching input work form
    ?rule mg:targetOutputWorkForm ?subwf . # Mixwork intended be published under Subwork work form
    ?rule mg:hasOutputDef ?outputDef . # Find the matching output definition (no use)
    (?action ?submixw ?subwork "ruling") log:skolem ?geniri . # Ensure that only one ruling is created for each (Publish, subwork, publication) tuple
} => {
    ?geniri a mg:Ruling ;
        mg:targetWork ?submixw ;
        mg:targetAction ?action ;
        mg:hasLicense ?linfo ;
        mg:hasRule ?rule . # Rule is binded
        #mg:hasOutputDef ?outputDef . # OutputDef is out of context
    ?subw mg:hasRuling ?geniri . # Add the ruling that publishing subwork to its following work
}.


####    Gather Restrictions  ####
# We consider that all publish tasks need to be accomplished, not distinguishing between the restrictions they trigger

:TriggeredRestriction a rdfs:Class .
:triggeredBy a rdfs:Property .
:hasRestrictionFromMixwork a rdfs:Property .
:hasRestrictionFromSubwork a rdfs:Property .


{ # Restrictions from mixwork
    ?pt a :PublishTask .
    ?work :hasPublishTask ?pt .
    ?work mg:hasRuling ?rl .
    ?rl mg:targetWork ?mw .
    ?work mg:hasMixwork ?mw . # According to ruling from mixwork
    ?mw :hasPublishTask ?pt .
    (?pt ?rl "TriggeredRestriction") log:skolem ?geniri .
} => {
    ?geniri a :TriggeredRestriction ;
        :triggeredBy ?pt ;
        :triggeredBy ?rl .
    ?work :hasRestrictionFromMixwork ?geniri .
} .
{ # Restrictions from subwork
    ?pt a :PublishTask .
    ?work :hasPublishTask ?pt .
    ?work mg:hasRuling ?rl .
    ?rl mg:targetWork ?sw .
    ?work mg:hasSubwork ?sw . # According to ruling from mixwork
    ?sw :hasPublishTask ?pt .
    (?pt ?rl "TriggeredRestriction") log:skolem ?geniri .
} => {
    ?geniri a :TriggeredRestriction ;
        :triggeredBy ?pt ;
        :triggeredBy ?rl .
    ?work :hasRestrictionFromSubwork ?geniri .
} .

{  # CASE: Internal Use
    ?tr a :TriggeredRestriction .
    ?tr :triggeredBy ?pt .
    ?pt a :PublishTask .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?work mg:hasRuling ?rl .
    ?pt!mg:hasPublishPolicy log:equalTo mg:internal . # Only internal use, not public publish
    ?rl!mg:hasRule mg:hasUseRestriction ?rest . # Use restrictions are triggered
    (?pt ?rl "TriggeredRestriction") log:skolem ?geniri .
} => {
    ?geniri mg:hasRestriction ?rest .
} .
{  # CASE: Share or Sell
    ?tr a :TriggeredRestriction .
    ?tr :triggeredBy ?pt .
    ?pt a :PublishTask .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?work mg:hasRuling ?rl .
    ?pt!mg:hasPublishPolicy list:in (mg:share mg:sell) . # Share or Sell, public publish
    ?rl!mg:hasRule mg:hasRestriction ?rest . # Both Use and Publish restrictions are triggered
    (?pt ?rl "TriggeredRestriction") log:skolem ?geniri .
} => {
    ?geniri mg:hasRestriction ?rest .
} .

{ # Proliferate Restrictions
    ?work a mg:Work .
    ?work mg:hasMixwork ?mw .
    ?mw :hasRestrictionFromMixwork ?rest .
} => {
    ?work :hasRestrictionFromMixwork ?rest .
} .
{
    ?work a mg:Work .
    ?work mg:hasMixwork ?mw .
    ?mw :hasRestrictionFromSubwork ?rest .
} => {
    ?work :hasRestrictionFromSubwork ?rest .
} .
{ 
    ?work a mg:Work .
    ?work mg:hasSubwork ?sw .
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromSubwork) .
    ?sw ?has ?rest .
} => {
    ?work :hasRestrictionFromSubwork :rest .
} .


####    Generate license analysis report rules  ####
# Warning W1 [License Type Mismatch]. Report a warning if the license's target work type does not match the actual work type

{   
    ?work a mg:Work .
    ?work mg:hasLicense ?license .
    ?work mg:hasWorkType ?wtype.
    ?license mg:targetWorkType ?ltype .
    ?wtype log:notEqualTo mg:mixed-type . # Skip it if the work type is mixed-type
    ?wtype log:notEqualTo ?ltype . # Type mismatching

    ?work mg:workName ?wname . # Genreate report content
    ?license mg:licenseId ?lid .
    ("** Warning ** [License Type Mismatch] " ?wname " is a " ?wtype " but it have a " ?ltype " license: " ?lid) string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?work ;
        mg:reportType "License Type Mismatch" ;
        mg:content ?report_content .
} .

# Warning W2 [Revocable License]. Report a warning if the license of a work is revocable
{   
    ?work a mg:Work .
    ?work mg:hasLicense ?license .
    _:x log:includes {?license!mg:grant mg:hasRightPrefix mg:revocable} .

    ?work mg:workName ?wname . # Genreate report content
    ?license mg:licenseId ?lid .
    ("** Warning ** [Revocable License] The " ?lid " license of " ?wname " is revocable") string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?work ;
        mg:reportType "Revocable License" ;
        mg:content ?report_content .
} .

# Warning W3 [Possibly Revocable License]. Report a warning if the license of a work is not explictly claim irrevocable
{   
    ?work a mg:Work .
    ?work mg:hasLicense ?license .
    _:x log:notIncludes {?license!mg:grant mg:hasRightPrefix mg:revocable} . # Not claim revocable
    _:x log:notIncludes {?license!mg:grant mg:hasRightPrefix mg:irrevocable} . # Not claim irrevocable

    ?work mg:workName ?wname . # Genreate report content
    ?license mg:licenseId ?lid .
    ("** Warning ** [Possibly Revocable License] The " ?lid " license of " ?wname " does not explicitly claim to be irrevocable") string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?work ;
        mg:reportType "Possibly Revocable License" ;
        mg:content ?report_content .
} .

# Error E1 [Wrong Work Type or Form]. The work type cannot be inconsistent with its work form; i.e., a 'software' work cannot have a 'vision' form.
{
    ?work a mg:Work .
    ?work mg:hasLicense ?license . # We filter out works that do not have a license
    ?work mg:hasWorkForm ?wform .
    ?wform log:notEqualTo mg:mixed-form . # Skip it if the work type is mixed-form
    ?wform mg:targetWorkType ?ttype .
    ?work mg:hasWorkType ?wtype .
    ?wtype log:notEqualTo mg:mixed-type . # Skip it if the work type is mixed-type
    ?wtype log:notEqualTo ?ttype . # Check the consistency between work type and work form

    ?work mg:workName ?wname . # Genreate report content
    ("** Error ** [Wrong Work Type or Form] " ?wname " is a " ?wtype " but it is in " ?wform " form") string:concatenation ?report_content .
} => {
    _:error a mg:Error ;
        mg:reportedBy ?work ;
        mg:reportType "Wrong Work Type or Form" ;
        mg:content ?report_content .
} .

# Notice N1 [Include License]. The original license file should be retained.
{   
    ?pt a :PublishTask .
    ?pt mg:targetWork ?w .
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromSubwork) . # Both check from mixwork and subwork
    ?w ?has ?tr .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:include_license_restriction . # This work has include license restriction

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Notice ** [" ?rtype "] To Publish " ?wname ", the " ?lid " license of "  ?inwname " should be retained") string:concatenation ?report_content .
} => {
    _:notice a mg:Notice ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Notice N2 [Include Notice]. The notices (e.g., attribution, copyright, patent, trademark) should be retained.
{   
    ?pt a :PublishTask .
    ?pt mg:targetWork ?w .
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromSubwork) . # Both check from mixwork and subwork
    ?w ?has ?tr .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:include_notice_restriction .

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Notice ** [" ?rtype "] To Publish " ?wname ", the notice files (e.g., attribution, copyright, patent, trademark) of "  ?inwname " should be retained") string:concatenation ?report_content .
} => {
    _:notice a mg:Notice ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Notice N3 [State Changes]. A notice stating the modifications made to work should be provided.
{   
    ?pt a :PublishTask .
    ?pt mg:targetWork ?w .
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromSubwork) . # Both check from mixwork and subwork
    ?w ?has ?tr .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:state_changes_restriction .
    ?rl!mg:hasOutputDef list:in (mg:derivative mg:nodefinition) . # If the new work is a derivative or nodefinition

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Notice ** [" ?rtype "] To Publish " ?wname ", a notice stating the modifications made to "  ?inwname " should be provided") string:concatenation ?report_content .
} => {
    _:notice a mg:Notice ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Notice N4 [Report Impact]. This work requires publisher to submit a Derivative Impact Report according to the related license.
{   
    ?pt a :PublishTask .
    ?pt mg:targetWork ?w .
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromSubwork) . # Both check from mixwork and subwork
    ?w ?has ?tr .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:report_impact_restriction . # This work has include license restriction

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Notice ** [" ?rtype "] " ?inwname " requires publisher to submit a Derivative Impact Report according to "  ?lid ) string:concatenation ?report_content .
} => {
    _:notice a mg:Notice ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Warning W5 [Discolse Source]. This work should disclose its source code.
{ # FromMixwork
    ?pt a :PublishTask .
    ?w :hasPublishTask ?pt . # The work has Pubulih Task
    ?w :hasRestrictionFromMixwork ?tr . # check from mixwork
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:disclose_self_restriction .
    ?w!mg:hasWorkForm!mg:broader log:notEqualTo mg:raw-form . # The form of this work is no raw (e.g., code)

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] " ?wname " should disclose its source code according to " ?lid " license of " ?inwname ) string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .
{ # FromSubwork
    ?pt a :PublishTask .
    ?w :hasPublishTask ?pt . # The work has Pubulih Task
    ?w :hasRestrictionFromSubwork ?tr . # check from subwork
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:disclose_self_restriction .
    ?rl mg:targetWork ?inw . # This subwork
    ?inw!mg:hasWorkForm!mg:broader log:notEqualTo mg:raw-form . # The form of this work is no raw (e.g., code)

    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] " ?inwname " should disclose its source code according to its" ?lid " license") string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?inw ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Warning W6 [Discolse Unmodified Source]. The unmodified source code of a work should be disclosed.
{   
    ?pt a :PublishTask .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rl mg:targetWork ?inw . # The work that require disclose source
    ?rest log:equalTo mg:disclose_unmodified_source_restriction .
    ?inw!mg:hasWorkForm!mg:broader log:notEqualTo mg:raw-form . # The form of this work is no raw (e.g., code)

    ?pt!mg:targetWork mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] To publish " ?wname ", the unmodified source code of " ?wname " should be disclosed according to " ?lid " license") string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?inw ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Warning W7 [Use Behavior]. The use of this work must comply with the usage behavior restrictions of license.
{ # FromMixwork
    ?pt a :PublishTask .
    ?w :hasPublishTask ?pt . # The work has Pubulih Task
    ?w :hasRestrictionFromMixwork ?tr . # check from mixwork
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:use_behavior_restriction .

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] The use of " ?wname " must comply with the usage behavior restrictions of " ?inwname " according to its license " ?lid) string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .
{ # FromSubwork
    ?pt a :PublishTask .
    ?w :hasPublishTask ?pt . # The work has Pubulih Task
    ?w :hasRestrictionFromSubwork ?tr . # check from subwork
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:use_behavior_restriction .
    ?rl mg:targetWork ?inw . # This subwork

    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] The use of " ?inwname " must comply with the usage behavior restrictions according its license" ?lid) string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?inw ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Warning W8 [Runtime Control]. There is a runtime restriction clause in work (e.g., forced updates).
{   
    ?pt a :PublishTask .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rl mg:targetWork ?inw . # The work that require disclose source
    ?rest log:equalTo mg:runtime_restriction .

    #?pt!mg:targetWork mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] There is a runtime restriction in " ?inwname " according to its license " ?lid) string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?inw ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .