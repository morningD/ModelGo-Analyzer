@prefix math: <http://www.w3.org/2000/10/swap/math#> .
@prefix list: <http://www.w3.org/2000/10/swap/list#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix string: <http://www.w3.org/2000/10/swap/string#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix mg: <http://www.modelgo.li/rdf/terms#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix : <http://example.org/ns#>.

####    Generate license analysis report rules  ####
# Warning W1 [License Type Mismatch]. Report a warning if the license's target work type does not match the actual work type

{   
    ?work a mg:Work .
    ?work mg:hasLicense ?license .
    ?work mg:hasWorkType ?wtype.
    ?license mg:targetWorkType ?ltype .
    ?wtype log:notEqualTo mg:mixed-type . # Skip it if the work type is mixed-type
    ?wtype log:notEqualTo ?ltype . # Type mismatching

    ?work mg:workName ?wname . # Genreate report content
    ?license mg:licenseId ?lid .
    ("** Warning ** [License Type Mismatch] " ?wname " is a " ?wtype " but it have a " ?ltype " license: " ?lid) string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?work ;
        mg:reportType "License Type Mismatch" ;
        mg:content ?report_content .
} .

# Warning W2 [Revocable License]. Report a warning if the license of a work is revocable
{   
    ?work a mg:Work .
    ?work mg:hasLicense ?license .
    _:x log:includes {?license!mg:grant mg:hasRightPrefix mg:revocable} .

    ?work mg:workName ?wname . # Genreate report content
    ?license mg:licenseId ?lid .
    ("** Warning ** [Revocable License] The " ?lid " license of " ?wname " is revocable") string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?work ;
        mg:reportType "Revocable License" ;
        mg:content ?report_content .
} .

# Warning W3 [Possibly Revocable License]. Report a warning if the license of a work is not explictly claim irrevocable
{   
    ?work a mg:Work .
    ?work mg:hasLicense ?license .
    _:x log:notIncludes {?license!mg:grant mg:hasRightPrefix mg:revocable} . # Not claim revocable
    _:x log:notIncludes {?license!mg:grant mg:hasRightPrefix mg:irrevocable} . # Not claim irrevocable

    ?work mg:workName ?wname . # Genreate report content
    ?license mg:licenseId ?lid .
    ("** Warning ** [Possibly Revocable License] The " ?lid " license of " ?wname " does not explicitly claim to be irrevocable") string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?work ;
        mg:reportType "Possibly Revocable License" ;
        mg:content ?report_content .
} .

# Error E1 [Wrong Work Type or Form]. The work type cannot be inconsistent with its work form; i.e., a 'software' work cannot have a 'vision' form.
{
    ?work a mg:Work .
    ?work mg:hasLicense ?license . # We filter out works that do not have a license
    ?work mg:hasWorkForm ?wform .
    ?wform log:notEqualTo mg:mixed-form . # Skip it if the work type is mixed-form
    ?wform mg:targetWorkType ?ttype .
    ?work mg:hasWorkType ?wtype .
    ?wtype log:notEqualTo mg:mixed-type . # Skip it if the work type is mixed-type
    ?wtype log:notEqualTo ?ttype . # Check the consistency between work type and work form

    ?work mg:workName ?wname . # Genreate report content
    ("** Error ** [Wrong Work Type or Form] " ?wname " is a " ?wtype " but it is in " ?wform " form") string:concatenation ?report_content .
} => {
    _:error a mg:Error ;
        mg:reportedBy ?work ;
        mg:reportType "Wrong Work Type or Form" ;
        mg:content ?report_content .
} .

# Notice N1 [Include License]. The original license file should be retained.
{   
    ?pt a :PublishTask .
    ?pt mg:targetWork ?w .
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromSubwork :hasRestrictionFromAuxwork) . # Check restrictions from mixwork, subwork, auxwork
    ?w ?has ?tr .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:include_license_restriction . # This work has include license restriction

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Notice ** [" ?rtype "] To Publish " ?wname ", the " ?lid " license of "  ?inwname " should be retained") string:concatenation ?report_content .
} => {
    _:notice a mg:Notice ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Notice N2 [Include Notice]. The notices (e.g., attribution, copyright, patent, trademark) should be retained.
{   
    ?pt a :PublishTask .
    ?pt mg:targetWork ?w .
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromSubwork :hasRestrictionFromAuxwork) . # Check restrictions from mixwork, subwork, auxwork
    ?w ?has ?tr .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:include_notice_restriction .

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Notice ** [" ?rtype "] To Publish " ?wname ", the notice files (e.g., attribution, copyright, patent, trademark) of "  ?inwname " should be retained") string:concatenation ?report_content .
} => {
    _:notice a mg:Notice ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Notice N3 [State Changes]. A notice stating the modifications made to work should be provided.
{   
    ?pt a :PublishTask .
    ?pt mg:targetWork ?w .
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromSubwork :hasRestrictionFromAuxwork) . # Check restrictions from mixwork, subwork, auxwork
    ?w ?has ?tr .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:state_changes_restriction .
    ?rl!mg:hasOutputDef list:in (mg:derivative mg:nodefinition) . # If the new work is a derivative or nodefinition

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Notice ** [" ?rtype "] To Publish " ?wname ", a notice stating the modifications made to "  ?inwname " should be provided") string:concatenation ?report_content .
} => {
    _:notice a mg:Notice ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Notice N4 [Report Impact]. This work requires publisher to submit a Derivative Impact Report according to the related license.
{   
    ?pt a :PublishTask .
    ?pt mg:targetWork ?w .
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromSubwork :hasRestrictionFromAuxwork) . # Check restrictions from mixwork, subwork, auxwork
    ?w ?has ?tr .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:report_impact_restriction . # This work has include license restriction

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Notice ** [" ?rtype "] " ?inwname " requires publisher to submit a Derivative Impact Report according to "  ?lid ) string:concatenation ?report_content .
} => {
    _:notice a mg:Notice ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Warning W5 [Discolse Source]. This work should disclose its source code.
{ # FromMixwork, FromAuxwork
    ?pt a :PublishTask .
    ?w :hasPublishTask ?pt . # The work has Pubulih Task
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromAuxwork) .
    ?w ?has ?tr . # check from mixwork and auxwork
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:disclose_self_restriction .
    ?w!mg:hasWorkForm!mg:broader log:notEqualTo mg:raw-form . # The form of this work is no raw (e.g., code)

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] " ?wname " should disclose its source code according to " ?lid " license of " ?inwname ) string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .
{ # FromSubwork
    ?pt a :PublishTask .
    ?w :hasPublishTask ?pt . # The work has Pubulih Task
    ?w :hasRestrictionFromSubwork ?tr . # check from subwork
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:disclose_self_restriction .
    ?rl mg:targetWork ?inw . # This subwork
    ?inw!mg:hasWorkForm!mg:broader log:notEqualTo mg:raw-form . # The form of this work is no raw (e.g., code)

    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] " ?inwname " should disclose its source code according to its" ?lid " license") string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?inw ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Warning W6 [Discolse Unmodified Source]. The unmodified source code of a work should be disclosed.
{   
    ?pt a :PublishTask .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rl mg:targetWork ?inw . # The work that require disclose source
    ?rest log:equalTo mg:disclose_unmodified_source_restriction .
    ?inw!mg:hasWorkForm!mg:broader log:notEqualTo mg:raw-form . # The form of this work is no raw (e.g., code)

    ?pt!mg:targetWork mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] To publish " ?wname ", the unmodified source code of " ?wname " should be disclosed according to " ?lid " license") string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?inw ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Warning W7 [Use Behavior]. The use of this work must comply with the usage behavior restrictions of license.
{ # FromMixwork, FromAuxwork
    ?pt a :PublishTask .
    ?w :hasPublishTask ?pt . # The work has Pubulih Task
    ?has list:in (:hasRestrictionFromMixwork :hasRestrictionFromAuxwork) .
    ?w ?has ?tr . # check from mixwork and auxwork
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:use_behavior_restriction .

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] The use of " ?wname " must comply with the usage behavior restrictions of " ?inwname " according to its license " ?lid) string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?w ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .
{ # FromSubwork
    ?pt a :PublishTask .
    ?w :hasPublishTask ?pt . # The work has Pubulih Task
    ?w :hasRestrictionFromSubwork ?tr . # check from subwork
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:use_behavior_restriction .
    ?rl mg:targetWork ?inw . # This subwork

    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] The use of " ?inwname " must comply with the usage behavior restrictions according its license " ?lid) string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?inw ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Warning W8 [Runtime Control]. There is a runtime restriction clause in work (e.g., forced updates).
{   
    ?pt a :PublishTask .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rl mg:targetWork ?inw . # The work that require disclose source
    ?rest log:equalTo mg:runtime_restriction .

    #?pt!mg:targetWork mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ?rest mg:reportType ?rtype .
    ("** Warning ** [" ?rtype "] There is a runtime restriction in " ?inwname " according to its license " ?lid) string:concatenation ?report_content .
} => {
    _:warning a mg:Warning ;
        mg:reportedBy ?inw ;
        mg:reportType ?rtype ;
        mg:content ?report_content .
} .

# Error E3 [Not Allowed to Share]. Redistribution of a work is prohibited.
{ # FromMixwork
    ?pt a :PublishTask .
    ?w :hasPublishTask ?pt . # The work has Pubulih Task
    ?w :hasRestrictionFromMixwork ?tr . # check from mixwork
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?rl!mg:hasRule!mg:allowSharing log:equalTo false . # No allow sharing

    ?rl mg:targetWork ?inw .
    ?w mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ("** Error ** [Not Allowed to Share] Redistribution of " ?wname " is prohibited according to license " ?lid " of " ?inwname) string:concatenation ?report_content .
} => {
    _:error a mg:Error ;
        mg:reportedBy ?w ;
        mg:reportType "Not Allowed to Share" ;
        mg:content ?report_content .
} .
{ # FromSubwork
    ?pt a :PublishTask .
    ?w :hasPublishTask ?pt . # The work has Pubulih Task
    ?w :hasRestrictionFromSubwork ?tr . # check from subwork
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rl!mg:hasRule!mg:allowSharing log:equalTo false . # No allow sharing
    ?rl mg:targetWork ?inw . # This subwork

    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ("** Error ** [Not Allowed to Share] Redistribution of " ?inwname " is prohibited according to license " ?lid " of " ?inwname) string:concatenation ?report_content .
} => {
    _:error a mg:Error ;
        mg:reportedBy ?inw ;
        mg:reportType "Not Allowed to Share" ;
        mg:content ?report_content .
} .

# Error E4 [Not Allowed to Sublicense]. Sublicensing of a work is prohibited.
{   
    ?pt a :PublishTask .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?rl mg:targetWork ?inw .
    ?inw mg:hasLicense ?li .
    _:t log:notIncludes { ?li!mg:grant!mg:hasRightPrefix log:equalTo mg:sublicensable } .
    _:t log:notIncludes { ?li!mg:grant!mg:hasUsage log:equalTo mg:sublicense } .
    _:t log:notIncludes { ?li!mg:grant!mg:hasUsage log:equalTo mg:auto-license } .

    #?pt!mg:targetWork mg:workName ?wname .
    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ("** Error ** [Not Allowed to Sublicense] Sublicensing of " ?inwname " is prohibited according to its license " ?lid) string:concatenation ?report_content .
} => {
    _:error a mg:Error ;
        mg:reportedBy ?inw ;
        mg:reportType "Not Allowed to Sublicense" ;
        mg:content ?report_content .
} .

# Error E5 [Non-Commercial Use]. Commercial use of work is prohibited.
{   
    ?pt a :PublishTask .
    ?tr :triggeredBy ?pt .
    ?tr :triggeredBy ?rl .
    ?rl a mg:Ruling .
    ?tr mg:hasRestriction ?rest . # Retrieve its restrictions
    ?rest log:equalTo mg:non_commericial_restriction . # No allow commercial use
    ?rl mg:targetWork ?inw .
    ?pt!mg:hasPublishPolicy log:equalTo mg:sell .

    ?inw mg:workName ?inwname .
    ?inw!mg:hasLicense mg:licenseId ?lid .
    ("** Error ** [Non-Commercial Use] Commercial use of " ?inwname " is prohibited according to its license " ?lid) string:concatenation ?report_content .
} => {
    _:error a mg:Error ;
        mg:reportedBy ?inw ;
        mg:reportType "Non-Commercial Use" ;
        mg:content ?report_content .
} .