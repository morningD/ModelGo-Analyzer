@prefix math: <http://www.w3.org/2000/10/swap/math#> .
@prefix list: <http://www.w3.org/2000/10/swap/list#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix string: <http://www.w3.org/2000/10/swap/string#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix mg: <http://www.modelgo.li/rdf/terms#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix : <http://example.org/ns#>.


# Request Proliferation Rule. Add the work's request to its Mixwork
{
    ?request a mg:Request .
    ?request <- mg:hasRequest ?work .
    ?work mg:hasMixwork ?mixwork .
} => {
    ?mixwork mg:hasRequest ?request .
} .

# Request Proliferation Rule for Publish Subwork. 
{
    ?rq a mg:Request .
    ?rq mg:targetAction ?action .
    ?action a mg:Publish . # The target action of this request is Publish
    ?rq <- mg:hasRequest ?work .
    ?work mg:hasSubwork ?subw .
} => {
    ?subwork mg:hasRequest ?rq .
} .

# [Combine] Request creating rule, which
# asks 'merge' right granting from original work
{
    ?action a mg:Combine .
    ?action!mg:hasInput mg:targetWork ?inw .
    ?action!mg:hasOutput mg:targetWork ?outw .
    (?action ?inw ?outw "request") log:skolem ?geniri . # NOTE: By this way, only one request can exsited in each (action, inw, outw) tuple.
} => {
    ?geniri a mg:Request ;
        mg:targetWork ?outw ;
        mg:targetAction ?action ;
        mg:grant [ 
            a mg:Right ;
            mg:hasUsage mg:merge
        ] .
    ?inw mg:hasRequest ?geniri .
} .

# [Train], [Amalgamate], [Modify] Request creating rule, which
# asks 'use' and 'modify' right granting from target work (i.e, model)
{
    ?action a ?atype .
    ?atype list:in (mg:Train mg:Amalgamate mg:Modify) .
    ?action!mg:hasInput mg:targetWork ?inw .
    ?action!mg:hasOutput mg:targetWork ?outw .
    (?action ?inw ?outw "request") log:skolem ?geniri .
} => {
    ?geniri a mg:Request ;
        mg:targetWork ?outw ;
        mg:targetAction ?action ;
        mg:grant [ 
            a mg:Right ;
            mg:hasUsage mg:use, mg:modify
        ] .
    ?inw mg:hasRequest ?geniri .
} .

# [Distill], [Generate], [Embed] Request creating rule, which
# asks 'use' right granting from target work (i.e, model)
{
    ?action a ?atype .
    ?atype list:in (mg:Distill mg:Generate mg:Embed) .
    ?action!mg:hasInput mg:targetWork ?inw .
    ?action!mg:hasOutput mg:targetWork ?outw .
    (?action ?inw ?outw "request") log:skolem ?geniri .
} => {
    ?geniri a mg:Request ;
        mg:targetWork ?outw ;
        mg:targetAction ?action ;
        mg:grant [ 
            a mg:Right ;
            mg:hasUsage mg:use
        ] .
    ?inw mg:hasRequest ?geniri .
} .

# [ALL actions] Ask 'use' right granting from auxwork (i.e, dataset) if provided
{
    ?action a mg:Action .
    ?action!mg:hasInput mg:targetAuxwork ?inaw .
    ?action!mg:hasOutput mg:targetWork ?outw .
    (?action ?inaw ?outw "request") log:skolem ?geniri .
} => {
    ?geniri a mg:Request ;
        mg:targetWork ?outw ;
        mg:targetAction ?action ;
        mg:grant [ 
            a mg:Right ;
            mg:hasUsage mg:use
        ] .
    ?inaw mg:hasRequest ?geniri .
} .

######## Publish Related Requests
# [Publish-sell] Ask 'redistribute', 'sublicense', 'commercial_use' from target (final) work 
{
    ?action a mg:Publish .
    ?action!mg:hasOutput!mg:targetWork mg:hasPublishPolicy ?policy .
    ?policy log:equalTo mg:sell . # sell
    ?action!mg:hasInput mg:targetWork ?inw .
    ?action!mg:hasOutput mg:targetWork ?outw .
    (?action ?inw ?outw "request") log:skolem ?geniri .
} => {
    ?geniri a mg:Request ;
        mg:targetWork ?outw ;
        mg:targetAction ?action ;
        mg:grant [ 
            a mg:Right ;
            mg:hasUsage mg:redistribute, mg:sublicense, mg:commercial_use
        ] .
    ?inw mg:hasRequest ?geniri .
} .

# [Publish-share] Ask 'redistribute', 'sublicense' from target (final) work 
{
    ?action a mg:Publish .
    ?action!mg:hasOutput!mg:targetWork mg:hasPublishPolicy ?policy .
    ?policy log:equalTo mg:share . # share
    ?action!mg:hasInput mg:targetWork ?inw .
    ?action!mg:hasOutput mg:targetWork ?outw .
    (?action ?inw ?outw "request") log:skolem ?geniri .
} => {
    ?geniri a mg:Request ;
        mg:targetWork ?outw ;
        mg:targetAction ?action ;
        mg:grant [ 
            a mg:Right ;
            mg:hasUsage mg:redistribute, mg:sublicense
        ] .
    ?inw mg:hasRequest ?geniri .
} .

# Note: No additional rights are required for publishing under Internal Use.